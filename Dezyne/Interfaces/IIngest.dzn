import ITimer.dzn;
import IMotor.dzn;
import ISensor.dzn;

interface IIngest {
	
	in void startIngest();
	out void finished();
	
	behaviour {
		enum State { Idle, Monitoring, Ingesting };
		State state = State.Idle;
		
		[state.Idle] {
			on startIngest: {}
		}
		
		[state.Monitoring] {
			on startIngest: illegal;
		}
		
		[state.Ingesting] {
			on startIngest: illegal;
		}
	}

}

component Ingester {
	provides IIngest ingest;
	requires IMotor wheelMotor;
	requires ISensor wheelStopSensor;
	requires ITimer timer;
	
	behaviour {
		enum State { Idle, Monitoring, Ingesting };
		State state = State.Idle;
		Long delay = $5000$; // in milliseconds, currently 5 seconds
		
		on wheelStopSensor.high(): {}
		
		[state.Idle] {
			on ingest.startIngest(): {
				state = State.Monitoring;
				timer.start(delay);
			}
		}
		
		
		[state.Monitoring] {
			on timer.timeout(): {
				state = State.Ingesting;
				wheelMotor.turnOn();
			}
		}
		
		[state.Ingesting] {
			on wheelStopSensor.high(): {
				state = State.Idle;
				wheelMotor.turnOff();
			}
		}
	}
	
}